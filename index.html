// 云函数入口文件（CloudBase Node 18）
// 安装依赖：axios
// tcb console 中配置环境变量：FEISHU_APP_ID, FEISHU_APP_SECRET, FEISHU_BASE_ID, FEISHU_TABLE_ID

const axios = require('axios');

exports.main = async (event, context) => {
  // 处理预检 CORS
  if (event.method === 'OPTIONS') {
    return {
      statusCode: 204,
      headers: corsHeaders(),
      body: ''
    };
  }

  try {
    const body = JSON.parse(event.body || '{}');
    const { name, phone, attend, pax, diet, note } = body;

    if (!name || !phone || !attend || !pax) {
      return json({ ok:false, msg:'参数不完整' }, 400);
    }

    // 获取 tenant_access_token
    const token = await getTenantToken();

    // 组装写入记录（根据你飞书表格的字段名调整）
    const record = {
      fields: {
        姓名: name,
        手机: phone,
        出席: attend === 'yes' ? '出席' : '不出席',
        人数: pax,
        饮食备注: diet || '',
        留言: note || '',
        提交时间: new Date().toISOString()
      }
    };

    const baseId  = process.env.FEISHU_BASE_ID;
    const tableId = process.env.FEISHU_TABLE_ID;

    const createUrl = `https://open.feishu.cn/open-apis/bitable/v1/apps/${baseId}/tables/${tableId}/records`;
    const resp = await axios.post(createUrl, { records: [record] }, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json; charset=utf-8'
      },
      timeout: 8000
    });

    if (resp.data && resp.data.data) {
      return json({ ok:true });
    } else {
      return json({ ok:false, msg:'飞书写入失败' }, 500);
    }
  } catch (err) {
    return json({ ok:false, msg: '服务异常' }, 500);
  }
};

function corsHeaders(){
  return {
    'Access-Control-Allow-Origin': '*', // 也可改为你的域名
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  };
}
function json(obj, status=200){
  return {
    statusCode: status,
    headers: { 'Content-Type':'application/json', ...corsHeaders() },
    body: JSON.stringify(obj)
  };
}

async function getTenantToken(){
  const resp = await axios.post('https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal', {
    app_id: process.env.FEISHU_APP_ID,
    app_secret: process.env.FEISHU_APP_SECRET
  }, { timeout: 6000 });
  if(resp.data && resp.data.tenant_access_token){
    return resp.data.tenant_access_token;
  }
  throw new Error('get tenant_access_token failed');
}
